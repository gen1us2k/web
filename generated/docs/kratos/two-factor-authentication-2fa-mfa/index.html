<!doctype html>
<html class="docs-version-v0.8" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setDocumentTitle",document.domain+"/"+document.title]),_paq.push(["setCookieDomain","*.ory.sh"]),_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="//sqa-web.ory.sh/";_paq.push(["setTrackerUrl",e+"np.php"]),_paq.push(["setSiteId","2"]);var a=document,p=a.createElement("script"),t=a.getElementsByTagName("script")[0];p.type="text/javascript",p.async=!0,p.src=e+"js/np.min.js",t.parentNode.insertBefore(p,t)}()</script>
<link rel="search" type="application/opensearchdescription+xml" title="Ory Kratos" href="/kratos/docs/opensearch.xml"><title data-react-helmet="true">Add Two Factor Authentication (2FA) to your App | Ory Kratos</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://www.ory.sh//kratos/docs/two-factor-authentication-2fa-mfa"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="v0.8"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-v0.8"><meta data-react-helmet="true" property="og:title" content="Add Two Factor Authentication (2FA) to your App | Ory Kratos"><meta data-react-helmet="true" name="description" content="Ory Kratos supports two-factor authentication. Depending on the devices used,"><meta data-react-helmet="true" property="og:description" content="Ory Kratos supports two-factor authentication. Depending on the devices used,"><link data-react-helmet="true" rel="shortcut icon" href="/kratos/docs/img/favico.png"><link data-react-helmet="true" rel="canonical" href="https://www.ory.sh//kratos/docs/two-factor-authentication-2fa-mfa"><link data-react-helmet="true" rel="alternate" href="https://www.ory.sh//kratos/docs/two-factor-authentication-2fa-mfa" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://www.ory.sh//kratos/docs/two-factor-authentication-2fa-mfa" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://V2EFIWEJ25-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/kratos/docs/assets/css/styles.74f6f1b0.css">
<link rel="preload" href="/kratos/docs/assets/js/runtime~main.ff5c27da.js" as="script">
<link rel="preload" href="/kratos/docs/assets/js/main.7d62090d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div id="route-identifier" data-route="/kratos/docs/two-factor-authentication-2fa-mfa"><div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" role="banner"><div class="announcementBarPlaceholder_2m9F"></div><div class="announcementBarContent_3EUC">Sign up for <a href="https://ory.us10.list-manage.com/subscribe?u=ffb1a878e4ec6c0ed312a3480&id=f605a41b53&group[17097][4]=1">important security announcements</a> and if you like Ory Kratos give it a ‚≠êÔ∏è on <a target="_blank" rel="noopener noreferrer" href="https://github.com/ory/kratos">GitHub</a>!</div><button type="button" class="clean-btn close announcementBarClose_38nx" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.ory.sh/kratos" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/kratos/docs/img/logo-kratos.svg" alt="Ory Kratos" class="themedImage_1VuW themedImage--light_3UqQ"><img src="/kratos/docs/img/logo-kratos.svg" alt="Ory Kratos" class="themedImage_1VuW themedImage--dark_hz6m"></div></a><a href="https://www.ory.sh/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Home</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ory/kratos/discussions" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://www.ory.sh/chat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a href="https://github.com/ory/kratos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/kratos/docs/">v0.8</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/kratos/docs/next/two-factor-authentication-2fa-mfa">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/kratos/docs/two-factor-authentication-2fa-mfa">v0.8</a></li><li><a class="dropdown__link" href="/kratos/docs/v0.7/">v0.7</a></li><li><a class="dropdown__link" href="/kratos/docs/v0.6/">v0.6</a></li><li><a class="dropdown__link" href="/kratos/docs/v0.5/">v0.5</a></li><li><a class="dropdown__link" href="/kratos/docs/v0.4/">v0.4</a></li><li><a class="dropdown__link" href="/kratos/docs/v0.3/">v0.3</a></li><li><a class="dropdown__link" href="/kratos/docs/v0.2/">v0.2</a></li><li><a class="dropdown__link" href="/kratos/docs/v0.1/">v0.1</a></li><li><a class="dropdown__link" href="/kratos/docs/versions">All versions</a></li></ul></div><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">üåú</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">üåû</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div><div class="searchBox_1Doo"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://www.ory.sh/docs/" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Welcome to Ory!<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://www.ory.sh/docs/get-started" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Become an Ory Insider<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://www.ory.sh/docs/early-access" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Ory Cloud Roadmap<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Start Building</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Guides</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a href="https://www.ory.sh/docs/reference/api" target="_blank" rel="noopener noreferrer" class="menu__link"><span>HTTP API Documentation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Reference</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Open Source Ory Kratos</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Concepts</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Self Service (End-User)</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Administration</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Guides</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/kratos/docs/two-factor-authentication-2fa-mfa">Add 2FA to your App</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/sign-in-with-github-google-facebook-linkedin">Sign in with GitHub, GitLab, Google, Facebook, LinkedIn, Microsoft ...</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/login-session">Configuring And Checking for Login Sessions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/configuring-cookies">Configuring Cookies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/multi-domain-cookies">Advanced Base URL, CSRF &amp; Session Cookie Settings</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/setting-up-cors">Setting up Cross-origin resource sharing (CORS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/account-recovery-password-reset">Setting up Account Recovery and Password Reset</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/account-activation-email-verification">Setting up Account Activation and E-Mail Verification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/zero-trust-iap-proxy-identity-access-proxy">Zero Trust with IAP Proxy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/multi-tenancy-multitenant">Multitenancy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/secret-key-rotation">Secret and Key Rotation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/retrieve-social-sign-in-access-refresh-id-token">Get Access, Refresh, ID Tokens from Social Sign In Providers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/setting-up-noop-cipher-parameters">Setting up Noop Cipher algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/setting-up-xchacha-cipher-parameters">Setting up XChaCha20 Poly1305 Cipher algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/setting-up-aes-cipher-parameters">Setting up AES Cipher algorithm</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/high-availability-ha">High Availability</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/docker">Docker Images</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/https-tls">Setting up HTTPS (TLS)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/setting-up-password-hashing-parameters">Setting up Argon2 Password Hashing Parameters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/integration-with-other-systems-using-web-hooks">Integration using Web-Hooks</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/guides/tracing">Distributed Tracing</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/kratos/docs/reference/api">HTTP API</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Reference</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Debug &amp; Help</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">SDKs</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Development</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Further Reading</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Keto</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Hydra</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Open Source Ory Oathkeeper</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><span class="theme-doc-version-badge badge badge--secondary">Version: <!-- -->v0.8</span><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Add Two Factor Authentication (2FA) to your App</h1></header><p>Ory Kratos supports two-factor authentication. Depending on the devices used,
you might want to call this two-factor verification depending on which features
you have enabled. Learn more about the distinction between two-factor
authentication and two-factor verification in this excellent
<a href="https://blog.1password.com/totp-for-1password-users/" target="_blank" rel="noopener noreferrer">1password</a> blog post!</p><p>There are four key components available in Ory Kratos with regard to
multi-factor authentication. For this guide, we will assume that you are using
the Ory Cloud Managed UI available at
<a href="https://github.com/ory/kratos-selfservice-ui-node" target="_blank" rel="noopener noreferrer">github.com/ory/kratos-selfservice-ui-node</a>.
At the end of this guide you will find details and ideas on how to implement
your own UI with Ory Kratos&#x27; MFA features.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="terminology">Terminology<a aria-hidden="true" class="hash-link" href="#terminology" title="Direct link to heading">‚Äã</a></h2><p>Before we start let&#x27;s establish the key terminology to make the following
sections easier to understand!</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="authenticator-assurance-level-aal">Authenticator Assurance Level (AAL)<a aria-hidden="true" class="hash-link" href="#authenticator-assurance-level-aal" title="Direct link to heading">‚Äã</a></h3><p>The Authenticator Assurance Level (AAL) has two possible values:</p><ul><li><code>aal1</code>: Implies that the identity has completed only one authentication factor
(<code>password</code>, <code>oidc</code>).</li><li><code>aal2</code>: Implies that the identity has completed the first (<code>password</code>, <code>oidc</code>)
and the second (<code>totp</code>, <code>lookup_secrets</code>, <code>webauthn</code>) authentication factor
(e.g.: <code>password</code> + <code>totp</code>, <code>oidc</code> + <code>webauthn</code>, ...). First authentication
factors can not be combined to gain <code>aal2</code> (e.g. <code>password</code> + <code>oidc</code> = <code>aal1</code>,
not <code>aal2</code>)!</li></ul><h3 class="anchor anchorWithStickyNavbar_31ik" id="authentication-method-reference-amr">Authentication Method Reference (AMR)<a aria-hidden="true" class="hash-link" href="#authentication-method-reference-amr" title="Direct link to heading">‚Äã</a></h3><p>The Authentication Method Reference (AMR) is an array of authentication methods
that were used over the lifetime of an Ory Session. In an Ory Session, this will
have the following layout:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">Example Ory Session JSON Payload</div><div class="codeBlockContent_hGly json5"><pre tabindex="0" class="prism-code language-json5 codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id: &#x27;6b51a3f2-6a2c-4557-90a8-4e23de7072aa&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  active: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authenticator_assurance_level: &#x27;aal2&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authentication_methods: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      method: &#x27;password&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      completed_at: &#x27;2021-10-14T09:37:53.872104Z&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      method: &#x27;lookup_secret&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      completed_at: &#x27;2021-10-14T09:41:16.771859Z&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The methods can be one of <code>password</code>, <code>oidc</code>, <code>totp</code>, <code>webauthn</code>,
<code>lookup_secrets</code>. A method can be included more than once, for example when the
identity refreshes their Ory Session by re-authenticating with e.g. their
password:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">Example Ory Session JSON Payload</div><div class="codeBlockContent_hGly json5"><pre tabindex="0" class="prism-code language-json5 codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id: &#x27;6b51a3f2-6a2c-4557-90a8-4e23de7072aa&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  active: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authenticator_assurance_level: &#x27;aal2&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authentication_methods: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      method: &#x27;password&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      completed_at: &#x27;2021-10-14T09:37:53.872104Z&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      method: &#x27;lookup_secret&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      completed_at: &#x27;2021-10-14T09:41:16.771859Z&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      method: &#x27;password&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      completed_at: &#x27;2021-10-14T12:00:00.134567Z&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="strict-and-lax-multi-factor-authentication">Strict and Lax Multi-Factor Authentication<a aria-hidden="true" class="hash-link" href="#strict-and-lax-multi-factor-authentication" title="Direct link to heading">‚Äã</a></h2><p>Before jumping into the concrete MFA modules, we take a lok at &quot;Soft
Multi-Factor Authentication&quot;. Ory Kratos has two endpoints which require an Ory
Session Token or Ory Session Cookie to function:</p><ul><li><a href="/kratos/docs/reference/api#operation/toSession"><code>/sessions/whoami</code></a></li><li>The <a href="/kratos/docs/self-service/flows/user-settings">self-service setting flow</a></li></ul><p>When you enable one of the 2FA methods, you can configure when an Ory Session
Token or Ory Session Cookie is considered &quot;valid&quot; for these two endpoints:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">kratos.config.yml</div><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">selfservice</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">flows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">settings</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">required_aal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aal1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">session</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">whoami</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">required_aal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aal1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The field <code>required_aal</code> can be one of:</p><ul><li><code>highest_available</code> (default): If set, requires identities who have set up a
second factor (e.g. <code>totp</code>, <code>webauthn</code>) to have an Ory Session where both
factors (e.g. <code>password</code> + <code>totp</code>) have been used to authenticated.</li><li><code>aal1</code>: Even if an identity has a second factor set up, an Ory Session with
only one factor (e.g. <code>oidc</code>, <code>password</code>) is enough to access it.</li></ul><p>For example, if you want your users to sign in without forcing the second
factor, you could set:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">kratos.config.yml</div><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">session</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">whoami</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">required_aal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> aal1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>When the user is doing something that needs more security (e.g. a bank
transfer), you could add a check which only allows Ory Sessions that have <code>aal2</code>
to access that feature.</p><p>The Ory Session, which you can get by calling the
<a href="/kratos/docs/reference/api#operation/toSession"><code>/sessions/whoami</code></a> endpoint,
contains the session&#x27;s <code>authenticator_assurance_level</code>. For a session which only
completed the first factor, this would be:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">GET /session/whoami</div><div class="codeBlockContent_hGly json5"><pre tabindex="0" class="prism-code language-json5 codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id: &#x27;6b51a3f2-6a2c-4557-90a8-4e23de7072aa&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  active: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authenticated_at: &#x27;2021-10-14T09:37:53.877216Z&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authenticator_assurance_level: &#x27;aal1&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>A session that has completed the second factor, this would be:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">GET /session/whoami</div><div class="codeBlockContent_hGly json5"><pre tabindex="0" class="prism-code language-json5 codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  id: &#x27;6b51a3f2-6a2c-4557-90a8-4e23de7072aa&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  active: true,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authenticated_at: &#x27;2021-10-14T09:37:53.877216Z&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authenticator_assurance_level: &#x27;aal2&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If <code>highest_available</code> is configured for the <code>/session/whoami</code> endpoint, then
Ory Kratos will instruct the user interface - if it is a browser flow - to
redirect to the 2FA screen after the end-user signs in with their first factor.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="requesting-second-factor-authentication">Requesting Second Factor Authentication<a aria-hidden="true" class="hash-link" href="#requesting-second-factor-authentication" title="Direct link to heading">‚Äã</a></h2><p>When an end-user is signed in you may prompt them to provide their second factor
by initiating a new Login using the
<a href="/kratos/reference/api#operation/initializeSelfServiceLoginFlowForBrowsers"><code>/self-service/login/browser</code></a>
or
<a href="/kratos/reference/api#operation/initializeSelfServiceLoginFlowWithoutBrowser"><code>/self-service/login/api</code></a>
API and setting the <code>aal</code> parameter to <code>aal2</code>. Once the end-user has provided
their second factor, the method (e.g. <code>totp</code>) will be added to the Or Session
AMR, the Ory Session AAL will be set to <code>aal2</code>, and <code>authenticated_at</code> will be
set to the current time.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/self-service/login/browser?aal=aal2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/self-service/login/api?aal=aal2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If the Ory Session has <code>aal2</code> already, this will error. In that case you can
request to refresh the session using the second factor:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><pre tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">/self-service/login/browser?refresh=true&amp;aal=aal2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/self-service/login/api?refresh=true&amp;aal=aal2</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="time-based-one-time-password-totp--authenticator-app">Time-Based One-Time Password (TOTP) / Authenticator App<a aria-hidden="true" class="hash-link" href="#time-based-one-time-password-totp--authenticator-app" title="Direct link to heading">‚Äã</a></h2><p>Time-Based One-Time Password (TOTP) is a standardized algorithm (see
<a href="https://datatracker.ietf.org/doc/html/rfc6238" target="_blank" rel="noopener noreferrer">RFC6238</a>) that is used by apps
supported by apps like Google Authenticator
(<a href="https://apps.apple.com/us/app/google-authenticator/id388497605" target="_blank" rel="noopener noreferrer">iOS</a>,
<a href="https://play.google.com/store/apps/details?id=com.google.android.apps.authenticator2" target="_blank" rel="noopener noreferrer">Android</a>),
<a href="https://support.1password.com/one-time-passwords/" target="_blank" rel="noopener noreferrer">1Password</a>,
<a href="https://bitwarden.com/help/article/authenticator-keys/" target="_blank" rel="noopener noreferrer">Bitwarden</a>, and many
others.</p><p><img alt="Google Authenticator App" src="/kratos/docs/assets/images/totp-google-auth-app-c9a3b5b41ba9868773594af5bb519bcd.png"></p><p>You can enable TOTP in your Ory Kratos config:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">kratos.config.yml</div><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">selfservice</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">methods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">totp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># The issuer (e.g. a domain name) will be shown in the TOTP app (e.g. Google Authenticator). It helps the user differentiate between different codes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">issuer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Example.com</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To help the user identify the correct code in their TOTP authenticator app, you
should set the <code>issuer</code> (see code example above) to your brand name or domain
name. However, users might have multiple identities registered in your system.
To help them distinguish between them, you can specify a traits in your Identity
Schema which should be the TOTP account name (in the screenshot above
<code>alice@example.org</code>):</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">identity.schema.json</div><div class="codeBlockContent_hGly patch"><pre tabindex="0" class="prism-code language-patch codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $schema: &#x27;http://json-schema.org/draft-07/schema#&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: &#x27;object&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  properties: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    traits: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      type: &#x27;object&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      properties: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        email: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          type: &#x27;string&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          format: &#x27;email&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          title: &#x27;Your E-Mail&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          minLength: 3,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &#x27;ory.sh/kratos&#x27;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            credentials: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+             totp: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+               account_name: true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+             }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In the settings UI, the user will be presented with a QR code, a secret which
can be used instead of the QR code, and a field to enter a TOTP password
generated by the linked TOTP app.</p><p><img alt="Google Authenticator App" src="/kratos/docs/assets/images/1-ae2053a6144b23007339aac056a1102e.png"></p><p>To complete the process, the Ory Session must be
<a href="/kratos/docs/concepts/session#privileged-session">privileged</a>. Once set up, the
end-user can unlink the TOTP device if e.g. it is lost:</p><p><img alt="Google Authenticator App" src="/kratos/docs/assets/images/1-ae2053a6144b23007339aac056a1102e.png"></p><h3 class="anchor anchorWithStickyNavbar_31ik" id="writing-e2e-tests-for-totp">Writing E2E Tests for TOTP<a aria-hidden="true" class="hash-link" href="#writing-e2e-tests-for-totp" title="Direct link to heading">‚Äã</a></h3><p>If you wish to write TOTP tests, take a look at
<a href="https://github.com/ory/kratos/blob/fc2cecfbeab811aa1a851f953b6bc2a4c119c412/test/e2e/cypress/integration/profiles/mfa/totp.spec.ts" target="_blank" rel="noopener noreferrer">how we solve E2E tests for TOTP</a>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="lookup-secrets">Lookup Secrets<a aria-hidden="true" class="hash-link" href="#lookup-secrets" title="Direct link to heading">‚Äã</a></h2><p>Lookup secrets are passwords generated by the server. These passwords can only
be used once, and the end-user typically downloads them, stores them in their
password manager, or writes them down. Lookup secrets are commonly used when the
end-user loses access to their TOTP or WebAuthn device!</p><p>On your settings UI, this method could look as follows. First, the end-user
generates new lookup secrets.</p><p><img alt="Generating new recovery codes" src="/kratos/docs/assets/images/1-be676ae65065e31098e02b7fa73374df.png"></p><p><img alt="New recovery codes" src="/kratos/docs/assets/images/2-5be8aba065d8d66c8c3665501f52e7b7.png"></p><p>The end-user must confirm these lookup secrets. This action requires a
<a href="/kratos/docs/concepts/session#privileged-session">privileged Ory Session</a> and the
user might be prompted to confirm the action by re-authenticating!</p><p><img alt="Generating new recovery codes" src="/kratos/docs/assets/images/privileged-a77d014776ee430adcf956bb568ae675.png"></p><p>Once confirmed, the end-user can use these lookup secrets as a second factor!
When a code was used,</p><p><img alt="Used recovery code" src="/kratos/docs/assets/images/3-729cb576d168bacea2ab2e9546ffdad5.png"></p><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>The end-user must ensure to re-generate lookup secrets before all lookup secrets
have been used up!</p></div></div><p>Lookup secrets are known by several names. Google for example calls them &quot;Backup
Codes&quot;. Another common name is &quot;2FA Recovery Codes&quot;.</p><p>You can enable this method in your Ory Kratos config:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">kratos.config.yml</div><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">selfservice</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">methods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">lookup_secret</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="fido2--u2f-webauthn">FIDO2 / U2F WebAuthn<a aria-hidden="true" class="hash-link" href="#fido2--u2f-webauthn" title="Direct link to heading">‚Äã</a></h2><p>The Web Authentication Browser API (also known as WebAuthn) is a
<a href="https://w3c.github.io/webauthn/" target="_blank" rel="noopener noreferrer">specification</a> written by the
<a href="https://www.w3.org/" target="_blank" rel="noopener noreferrer">W3C</a> and <a href="https://fidoalliance.org/" target="_blank" rel="noopener noreferrer">FIDO</a>. The WebAuthn
API allows servers to register and authenticate users using public key
cryptography instead of a password. Common use cases for WebAuthn are</p><ul><li>using a USB, NFC, or Bluetooth low energy device (e.g.
<a href="https://www.yubico.com" target="_blank" rel="noopener noreferrer">YubiKey</a>) to authenticate</li><li>using an Operating System &quot;platform module&quot; (e.g. TouchID, FaceID, Windows
Hello Face, Android Biometric Authentication, ...)</li></ul><p>Configuring WebAuthn correctly is imperative, because the authentication will
fail if something is not configured correctly.</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">kratos.config.yml</div><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">selfservice</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">flows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">methods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">webauthn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">enabled</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">rp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># This MUST be your top-level-domain</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> example.org</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># This MUST be the exact URL of the page which will prompt for WebAuthn!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># Only the scheme (https / http), host (auth.example.org), and port (4455) are relevant. The</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># path is irrelevant</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">origin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//auth.example.org</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4455</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># A display name which will be shown to the user on her/his device.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">display_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ory</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Once the end-user triggers the WebAuthn process, the browser will show a
WebAuthn prompt:</p><p><img alt="WebAuthn Prompt" src="/kratos/docs/assets/images/1-626af5cf55ebab2ff62e4315b77e7acc.png"></p><h3 class="anchor anchorWithStickyNavbar_31ik" id="writing-e2e-tests">Writing E2E Tests<a aria-hidden="true" class="hash-link" href="#writing-e2e-tests" title="Direct link to heading">‚Äã</a></h3><p>You will need a browser to run E2E tests using WebAuthn. Take a look at our
<a href="https://github.com/ory/kratos/blob/fc2cecfbeab811aa1a851f953b6bc2a4c119c412/test/e2e/cypress/integration/profiles/mfa/webauthn.spec.ts" target="_blank" rel="noopener noreferrer">E2E test for WebAuthn</a>
for <a href="https://www.cypress.io" target="_blank" rel="noopener noreferrer">Cypress</a>. You can find more information about the
approach for Cypress in
<a href="https://github.com/cypress-io/cypress/issues/6991#issuecomment-612888645" target="_blank" rel="noopener noreferrer">cypress#6991</a>.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="webauthn-constraints">WebAuthN Constraints<a aria-hidden="true" class="hash-link" href="#webauthn-constraints" title="Direct link to heading">‚Äã</a></h3><p>There are some limitations to WebAuthn to be considered in development:</p><ul><li><p>WebAuthN is a Browser standard. It does not work on native mobile apps.</p></li><li><p>WebAuthN is limited to one domain and does not work in a local environment when using CNAME / Ory Proxy.<br>
<!-- -->WebAuthN uses an <code>https://origin</code> URL as part of the client&lt;-&gt;server challenge/response mechanism. This mechanism allows for only one URL as the origin. Read more in the <a href="https://webauthn.guide/" target="_blank" rel="noopener noreferrer">WebAuthN guide</a> and on <a href="https://github.com/w3c/webauthn/issues/1372" target="_blank" rel="noopener noreferrer">GitHub</a>.</p></li><li><p>Implementing WebAuthN in your own UI can be challenging, depending on which framework to use. Please check our <a href="/kratos/docs/guides/custom-ui">reference implementations</a> to see how we solved it for
different app types (web, single page app).</p></li></ul><h2 class="anchor anchorWithStickyNavbar_31ik" id="build-your-own-ui">Build Your Own UI<a aria-hidden="true" class="hash-link" href="#build-your-own-ui" title="Direct link to heading">‚Äã</a></h2><p>The major benefit of Ory Kratos is that you can bring your own login,
registration, account recovery, ... user-interface. You can write that
user-interface in any language or framework! We have
<a href="/kratos/docs/concepts/ui-user-interface">reference UI implementations</a> available to
help you get started!</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ory/kratos/edit/master/docs/versioned_docs/version-v0.8/guides/2fa.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2021-12-17T10:04:10.000Z">12/17/2021</time></b> by <b>Vincent</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/kratos/docs/admin/managing-users-identities"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ <!-- -->Managing Users and Identities</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/kratos/docs/guides/sign-in-with-github-google-facebook-linkedin"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Sign in with GitHub, GitLab, Google, Facebook, LinkedIn, Microsoft ...<!-- --> ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#terminology" class="table-of-contents__link toc-highlight">Terminology</a><ul><li><a href="#authenticator-assurance-level-aal" class="table-of-contents__link toc-highlight">Authenticator Assurance Level (AAL)</a></li><li><a href="#authentication-method-reference-amr" class="table-of-contents__link toc-highlight">Authentication Method Reference (AMR)</a></li></ul></li><li><a href="#strict-and-lax-multi-factor-authentication" class="table-of-contents__link toc-highlight">Strict and Lax Multi-Factor Authentication</a></li><li><a href="#requesting-second-factor-authentication" class="table-of-contents__link toc-highlight">Requesting Second Factor Authentication</a></li><li><a href="#time-based-one-time-password-totp--authenticator-app" class="table-of-contents__link toc-highlight">Time-Based One-Time Password (TOTP) / Authenticator App</a><ul><li><a href="#writing-e2e-tests-for-totp" class="table-of-contents__link toc-highlight">Writing E2E Tests for TOTP</a></li></ul></li><li><a href="#lookup-secrets" class="table-of-contents__link toc-highlight">Lookup Secrets</a></li><li><a href="#fido2--u2f-webauthn" class="table-of-contents__link toc-highlight">FIDO2 / U2F WebAuthn</a><ul><li><a href="#writing-e2e-tests" class="table-of-contents__link toc-highlight">Writing E2E Tests</a></li><li><a href="#webauthn-constraints" class="table-of-contents__link toc-highlight">WebAuthN Constraints</a></li></ul></li><li><a href="#build-your-own-ui" class="table-of-contents__link toc-highlight">Build Your Own UI</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Company</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.ory.sh/imprint" target="_blank" rel="noopener noreferrer" class="footer__link-item">Imprint</a></li><li class="footer__item"><a href="https://www.ory.sh/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://www.ory.sh/tos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div>Copyright ¬© 2022 ORY GmbH</div></div></div></footer></div></div>
<script src="/kratos/docs/assets/js/runtime~main.ff5c27da.js"></script>
<script src="/kratos/docs/assets/js/main.7d62090d.js"></script>
<script src="https://www.ory.sh/scripts.js" async></script>
<noscript><p><img src="//sqa-web.ory.sh/np.php?idsite=2&amp;rec=1" style="border:0;" alt=""></p></noscript></body>
</html>
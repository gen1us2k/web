---
templateKey: blog
path: '/securing-flask-application-using-kratos-and-keto/'
author: gen1us2k
title: Securing Your Flask Application Using Kratos and Keto
teaser: Securing your flask application using kratos and keto
subtitle: Let's build a flask application using Ory Kratos and Ory Keto
overline: Securing flask application using Kratos and Keto
publishedAt: 2022-01-24
published: true
featuredimage: media/logo-copy.png
description: ""
tags: []
---
In this blog post, I will show you an example of how you can secure your homepage using Ory Kratos and Ory Keto. The Flask application will have the following flow for authorization:

1. A user opens a homepage
2. Flask view gets 'ory_kratos_session' value from request cookie
3. Restrict access to the homepage if the user is inactive
4. Get the user's identity from Kratos
5. Restrict access to the homepage if we have no user's identity from Kratos
6. Restrict access to the homepage if access is not allowed by Keto

## Boostraping the project

This project will use Postgres, Docker and docker-compose for demonstration. We will use one instance of Postgres per service to make this example easier for understanding.
You can boostrap your project using [flask cookiecutter](https://github.com/cookiecutter-flask/cookiecutter-flask) template

## Setting up Kratos

According to the [quickstart](https://www.ory.sh/kratos/docs/quickstart) guide you need to:

1. Copy contents of [contrib/quickstart/kratos/email-password](https://github.com/ory/kratos/tree/master/contrib/quickstart/kratos/email-password) folder to your project
2. Add the following content to the docker-compose
 you can easily understand how does kratos works but in our case we will do some modifications

```yaml
services:
  kratos-migrate:
    image: oryd/kratos:v0.8.0-alpha.3
    links:
      - postgresd:postgresd
    environment:
      - DSN=postgres://kratos:secret@postgresd:5432/kratos?sslmode=disable&max_conns=20&max_idle_conns=4
    networks:
      - intranet
    volumes:
      - type: bind
        source: ./kratos
        target: /etc/config/kratos
    command: -c /etc/config/kratos/kratos.yml migrate sql -e --yes

  kratos:
    image: oryd/kratos:v0.8.0-alpha.3
    links:
      - postgresd:postgresd
    environment:
      - DSN=postgres://kratos:secret@postgresd:5432/kratos?sslmode=disable&max_conns=20&max_idle_conns=4
    ports:
      - '4433:4433'
      - '4434:4434'
    volumes:
      - type: bind
        source: ./kratos
        target: /etc/config/kratos
    networks:
      - intranet
    command: serve -c /etc/config/kratos/kratos.yml --dev --watch-courier


  postgresd:
    image: postgres:9.6
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=kratos
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=kratos
    networks:
      - intranet

  kratos-selfservice-ui-node:
    image: oryd/kratos-selfservice-ui-node:v0.8.0-alpha.3
    environment:
      - KRATOS_PUBLIC_URL=http://kratos:4433/
      - KRATOS_BROWSER_URL=http://127.0.0.1:4433/
    networks:
      - intranet
    ports:
      - "4455:3000"
    restart: on-failure


  mailslurper:
    image: oryd/mailslurper:latest-smtps
    ports:
      - '4436:4436'
      - '4437:4437'
    networks:
      - intranet
networks:
  intranet:
```

## Configuring Keto

```yaml
  postgresd-auth:
    image: postgres:9.6
    ports:
      - "15432:5432"
    environment:
      - POSTGRES_USER=keto
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=keto
    networks:
      - intranet
  keto-migrate:
    image: oryd/keto:v0.7.0-alpha.1
    volumes:
      - type: bind
        source: ./keto
        target: /home/ory
    environment:
      - LOG_LEVEL=debug
      - DSN=postgres://keto:secret@postgresd-auth:5432/keto?sslmode=disable&max_conns=20&max_idle_conns=4
    command: ["migrate", "up", "-y"]
    restart: on-failure
    depends_on:
      - postgresd
    networks:
      - intranet

  keto-perms:
    image: oryd/keto:v0.7.0-alpha.1
    volumes:
      - type: bind
        source: ./keto
        target: /home/ory
    environment:
      - KETO_WRITE_REMOTE=keto:4467
      - KETO_READ_REMOTE=keto:4466
      - LOG_LEVEL=debug
      - DSN=postgres://keto:secret@postgresd-auth:5432/keto?sslmode=disable&max_conns=20&max_idle_conns=4
    depends_on:
      - postgresd
    networks:
      - intranet

  keto:
    image: oryd/keto:v0.7.0-alpha.1
    volumes:
      - type: bind
        source: ./keto
        target: /home/ory
    ports:
      - '4466:4466'
      - '4467:4467'
    depends_on:
      - keto-migrate
    environment:
      - DSN=postgres://keto:secret@postgresd-auth:5432/keto?sslmode=disable&max_conns=20&max_idle_conns=4
    networks:
      - intranet
    command: serve
```

## Flask part

```python

HTTP_STATUS_FORBIDDEN = 403


@blueprint.route("/", methods=["GET", "POST"])
def home():
    """Home page."""

    if 'ory_kratos_session' not in request.cookies:
        return redirect(settings.KRATOS_UI_URL)


    response = requests.get(
        f"{settings.KRATOS_EXTERNAL_API_URL}/sessions/whoami",
        cookies=request.cookies
    )
    active = response.json().get('active')
    if not active:
        abort(HTTP_STATUS_FORBIDDEN)

    email = response.json().get('identity', {}).get('traits', {}).get('email').replace('@', '')

    # Check permissions

    response = requests.get(
        f"{settings.KETO_API_READ_URL}/check",
        params={
            "namespace": "app",
            "object": "homepage",
            "relation": "read",
            "subject_id": email,
        }
    )
    if not response.json().get("allowed"):
        abort(HTTP_STATUS_FORBIDDEN)

    return render_template("public/home.html")
```

## Nota bene

1. Get value of `ory_kratos_session` cookie and don't pass
2. Use Flask middleware and `ory/kratos` `keto` clients

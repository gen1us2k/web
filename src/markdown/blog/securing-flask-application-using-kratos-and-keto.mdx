---
templateKey: blog
path: '/securing-flask-application-using-kratos-and-keto/'
author: gen1us2k
title: Securing Your Flask Application Using Kratos and Keto
teaser: Securing your flask application using Kratos and Keto
subtitle: Let's build a flask application using Ory Kratos and Ory Keto
overline: Securing flask application using Kratos and Keto
publishedAt: 2022-01-24
published: true
featuredimage: media/logo-copy.png
description: ""
tags: []
---
import CodeFromRemote from '../../components/freestanding/utils/codefromremote'
import Mermaid from '@theme/Mermaid'

Nowadays the engineering community has many products for authentication in their frameworks. Lots of them have built-in features for authentication and a lot of libraries available for social sign-in. We have the Django framework, Flask, and python-social-auth to build almost everything we need to authenticate users in the pythonic world.

In this article, I'll show you an example of how to have everything we need for the user's authentication without writing lots of lines of code. Code used in this blog post is available on [GitHub](https://github.com/gen1us2k/kratos_flask_example)

Let's take a look at the login flow of our application using Ory Kratos and Ory Keto
[![](https://mermaid.ink/img/pako:eNptkktOIzEQhq9S8iojMSIShIUXSIjHCM2CRZRdS1CyK2kraVeP7RYKCGkuMIs5AbsR7DgTJ-AIlNsN0ZB4U9Xu7__rId8rw5aUVpF-deQNnTlcBGwqD3JaDMkZ16JP0EUKgBFmEiOM3h7_Pr3-_vP2-O9F0uch_batWwZMHGeXWfuzz0E-RvrwcDLZgQ_IJ5zBg4Md4HyFcZm5iz4Z6cl4PN5lSIl7uxyz29GRUIXLM30_Pu6tNFy15AGh5oZaXFBBcJVg6hYeLv1-jrO23OfT6zb6H5TghsP6uox8HSlGx_4GDPPS0bauTFiEzpJPLq0hBXQpwjxwA_u3NWPjgLxt2flULGgVCbBLdVYYTGSHe283PZ8YI-XhlH0KvNpRW9ahwdRkZImFlf2I55f5P4txcHdblQa3vEcN05pvY29hpKo0Bzz_zzErim7TTz5qTzUUGnRWHuJ9_lcp0TVUKS2pxbCsVOUfhOtaKwOfW5c4KD1H6W5PSXs8XXujdAodfUDDSx6oh3d7rfx0)](https://mermaid.live/edit#pako:eNptkktOIzEQhq9S8iojMSIShIUXSIjHCM2CRZRdS1CyK2kraVeP7RYKCGkuMIs5AbsR7DgTJ-AIlNsN0ZB4U9Xu7__rId8rw5aUVpF-deQNnTlcBGwqD3JaDMkZ16JP0EUKgBFmEiOM3h7_Pr3-_vP2-O9F0uch_batWwZMHGeXWfuzz0E-RvrwcDLZgQ_IJ5zBg4Md4HyFcZm5iz4Z6cl4PN5lSIl7uxyz29GRUIXLM30_Pu6tNFy15AGh5oZaXFBBcJVg6hYeLv1-jrO23OfT6zb6H5TghsP6uox8HSlGx_4GDPPS0bauTFiEzpJPLq0hBXQpwjxwA_u3NWPjgLxt2flULGgVCbBLdVYYTGSHe283PZ8YI-XhlH0KvNpRW9ahwdRkZImFlf2I55f5P4txcHdblQa3vEcN05pvY29hpKo0Bzz_zzErim7TTz5qTzUUGnRWHuJ9_lcp0TVUKS2pxbCsVOUfhOtaKwOfW5c4KD1H6W5PSXs8XXujdAodfUDDSx6oh3d7rfx0)

## What we will use in our project

- [Flask cookiecutter](https://github.com/cookiecutter-flask/cookiecutter-flask) is a great tool to bootstrap our project structure. It's always a great idea to have ready-to-use linters, Dockerfile, and package management tools from the box.
- Postgres as an RDBMS. We will have two Postgres services running in two containers in this example. I think that it's a great idea to keep it simple without using custom scripts to have multiple databases available in a single docker-compose service.
- Ory Kratos with UI to authenticate users
- Ory Keto as an access control service

## Setting up  Kratos

Kratos will be responsible for storing identity data such as email/login and password.
Using the [quickstart](https://www.ory.sh/kratos/docs/quickstart) guide we need to copy contents of [contrib/quickstart/kratos/email-password](https://github.com/ory/kratos/tree/master/contrib/quickstart/kratos/email-password) to the root of your project and then add the following content to the docker-compose

<CodeFromRemote
  lang="yml"
  src="https://github.com/gen1us2k/kratos_flask_example/blob/master/docker-compose.yml"
  startAt="postgres-kratos:"
  endAt="postgres-keto:"
/>

## Setting up Keto
You can get familiar with [Keto concepts](https://www.ory.sh/keto/docs/concepts/relation-tuples/) reading [quickstart](https://www.ory.sh/keto/docs/quickstart/) guide. These articles can give you a brief introduction to it. Since we need to manage access to the home page, we need to create a folder `keto` at the root of our project and have a `keto/keto.yml` file with the following content

<CodeFromRemote
  lang="yml"
  src="https://github.com/gen1us2k/kratos_flask_example/blob/master/keto/keto.yml"
  startAt="postgres-keto:"
  endAt="volumes:"
/>

We need to have the following containers

- postgresd-auth this is the database for Keto
- keto-migrate is a tool that makes database migrations
- keto-perms is a wrapper to work with permissions using a command-line interface
- keto runs the server

<CodeFromRemote
  lang="yml"
  src="https://github.com/gen1us2k/kratos_flask_example/blob/master/docker-compose.yml"
  startAt="postgresd-auth:"
/>

### Working with policies

Keto has configured namespace `app` to use in Flask application. Following the guide [Check whether a User has Access to Something](https://www.ory.sh/keto/docs/guides/simple-access-check-guide) I decided to implement simple permission policy for the demo project:

- Use keto-cli managing permissions
- Use email for [subjects](https://www.ory.sh/keto/docs/concepts/subjects) without `@` symbol

*Pros*

- Easy to use and maintain
- Can easily automated using CI/CD pipelines

*Cons*

- Lack of UI can be dealbreaker for non-engineering staff
- It can violate [GDPR](https://gdpr-info.eu/), [HIPAA](https://www.cdc.gov/phlp/publications/topic/hipaa.html#:~:text=The%20Health%20Insurance%20Portability%20and,the%20patient's%20consent%20or%20knowledge.) or any other compliances because we use personal data in this case



## Flask part

<CodeFromRemote
  lang="yml"
  src="https://github.com/gen1us2k/kratos_flask_example/blob/master/app/public/views.py"
  startAt="HTTP_STATUS_FORBIDDEN = 403"
/>

## Nota bene

1. Get value of `ory_kratos_session` cookie and don't pass
2. Use Flask middleware and `ory/kratos` `keto` clients
3. It's better to use Ory Cloud instead of Open Source Kratos version

## Next steps

1. [Add Two Factor Authentication (2FA) to your App](https://www.ory.sh/kratos/docs/next/two-factor-authentication-2fa-mfa/)
2. [Add social signin features](https://www.ory.sh/kratos/docs/next/guides/sign-in-with-github-google-facebook-linkedin/)
3. [Configure more secure password policies](https://www.ory.sh/kratos/docs/next/guides/password-policy/)
4. [Implement email and phone verification and account Activation](https://www.ory.sh/kratos/docs/next/self-service/flows/verify-email-account-activation/)

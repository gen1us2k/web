---
templateKey: blog
path: '/securing-flask-application-using-kratos-and-keto/'
author: gen1us2k
title: Securing Your Flask Application Using Kratos and Keto
teaser: Securing your flask application using Kratos and Keto
subtitle: Let's build a flask application using Ory Kratos and Ory Keto
overline: Securing flask application using Kratos and Keto
publishedAt: 2022-01-24
published: true
featuredimage: media/logo-copy.png
description: ""
tags: []
---
import CodeFromRemote from '../../components/freestanding/utils/codefromremote'

Nowadays engineering community has many products for authentication in their frameworks. Lots of them have built-in features for authentication and a lot of libraries available for social sign-in. We have Django framework, Flask, and python-social-auth to build almost everything we need to authenticate users in the pythonic world.

In this article, I'll show you an example of how to have everything we need for the user's authentication without writing lots of lines of code.

Let's take a look at the login flow of our application using Ory Kratos and Ory Keto:

- A user opens a homepage
- Flask view gets 'ory_kratos_session' value from request cookie
- Restrict access to the homepage if the user is inactive
- Get the user's identity from Kratos
- Restrict access to the homepage if we have no user's identity from Kratos
- Restrict access to the homepage if access is not allowed by Keto

## What we will use in our project

- [flask cookiecutter](https://github.com/cookiecutter-flask/cookiecutter-flask) is a great tool to bootstrap our project structure. It's always a great idea to have ready-to-use linters, Dockerfile, and package management tools from the box.
- Postgres as an RDBMS. We will have two Postgres services running in two containers in this example. I think that it's a great idea to keep it simple without using custom scripts to have multiple databases available in a single docker-compose service.
- Ory Kratos with UI to authenticate users
- Ory Keto as an access control service

## Setting up  Kratos

Kratos will be responsible for storing identity data such as email/login and password.
Using the [quickstart](https://www.ory.sh/kratos/docs/quickstart) guide we need to Copy contents of [contrib/quickstart/kratos/email-password](https://github.com/ory/kratos/tree/master/contrib/quickstart/kratos/email-password) to the root of your project and then add the following content to the docker-compose

<CodeFromRemote
  lang="yml"
  src="https://github.com/gen1us2k/kratos_flask_example/blob/master/docker-compose.yml"
  startAt="kratos-migrate:"
  endAt="keto-migrate:"
/>

Please, don't forget to add your flask service to the intranet network, or you can run it locally using the `flask run` command.

## Setting up Keto
You can get familiar with [Keto concepts] reading [quickstart](https://www.ory.sh/keto/docs/quickstart/) guide. These articles can give you a brief introduction to it. Since we need to manage access to the home page, we need to create a folder `keto` at the root of our project and have a `keto/keto.yml` file with the following content

<CodeFromRemote
  lang="yml"
  src="https://github.com/gen1us2k/kratos_flask_example/blob/master/keto/keto.yml"
  startAt="kratos-migrate:"
  endAt="keto-migrate:"
/>
```yaml
version: v0.7.0-alpha.1

log:
  level: debug

namespaces:
  - name: app
    id: 1

serve:
  read:
    host: 0.0.0.0
    port: 4466
  write:
    host: 0.0.0.0
    port: 4467
```

We need to have the following containers

- postgresd-auth this is the database for Keto
- keto-migrate is a tool that makes database migrations
- keto-perms is a wrapper to work with permissions using a command-line interface
- keto runs the server

We need to add the following configuration to `docker-compose.yml`

```yaml
  postgresd-auth:
    image: postgres:9.6
    ports:
      - "15432:5432"
    environment:
      - POSTGRES_USER=keto
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=keto
    networks:
      - intranet
  keto-migrate:
    image: oryd/keto:v0.7.0-alpha.1
    volumes:
      - type: bind
        source: ./keto
        target: /home/ory
    environment:
      - LOG_LEVEL=debug
      - DSN=postgres://keto:secret@postgresd-auth:5432/keto?sslmode=disable&max_conns=20&max_idle_conns=4
    command: ["migrate", "up", "-y"]
    restart: on-failure
    depends_on:
      - postgresd
    networks:
      - intranet

  keto-perms:
    image: oryd/keto:v0.7.0-alpha.1
    volumes:
      - type: bind
        source: ./keto
        target: /home/ory
    environment:
      - KETO_WRITE_REMOTE=keto:4467
      - KETO_READ_REMOTE=keto:4466
      - LOG_LEVEL=debug
      - DSN=postgres://keto:secret@postgresd-auth:5432/keto?sslmode=disable&max_conns=20&max_idle_conns=4
    depends_on:
      - postgresd
    networks:
      - intranet

  keto:
    image: oryd/keto:v0.7.0-alpha.1
    volumes:
      - type: bind
        source: ./keto
        target: /home/ory
    ports:
      - '4466:4466'
      - '4467:4467'
    depends_on:
      - keto-migrate
    environment:
      - DSN=postgres://keto:secret@postgresd-auth:5432/keto?sslmode=disable&max_conns=20&max_idle_conns=4
    networks:
      - intranet
    command: serve
```

## Flask part

```python

HTTP_STATUS_FORBIDDEN = 403


@blueprint.route("/", methods=["GET", "POST"])
def home():
    """Home page."""

    if 'ory_kratos_session' not in request.cookies:
        return redirect(settings.KRATOS_UI_URL)


    response = requests.get(
        f"{settings.KRATOS_EXTERNAL_API_URL}/sessions/whoami",
        cookies=request.cookies
    )
    active = response.json().get('active')
    if not active:
        abort(HTTP_STATUS_FORBIDDEN)

    email = response.json().get('identity', {}).get('traits', {}).get('email').replace('@', '')

    # Check permissions

    response = requests.get(
        f"{settings.KETO_API_READ_URL}/check",
        params={
            "namespace": "app",
            "object": "homepage",
            "relation": "read",
            "subject_id": email,
        }
    )
    if not response.json().get("allowed"):
        abort(HTTP_STATUS_FORBIDDEN)

    return render_template("public/home.html")
```

## Nota bene

1. Get value of `ory_kratos_session` cookie and don't pass
2. Use Flask middleware and `ory/kratos` `keto` clients
